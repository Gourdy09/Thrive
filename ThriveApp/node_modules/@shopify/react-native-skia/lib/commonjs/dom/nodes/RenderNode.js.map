{"version":3,"names":["_types","require","_datatypes","_Node","_defineProperty","obj","key","value","_toPropertyKey","Object","defineProperty","enumerable","configurable","writable","t","i","_toPrimitive","String","r","e","Symbol","toPrimitive","call","TypeError","Number","paintProps","JsiRenderNode","JsiNode","constructor","ctx","type","props","matrix","Skia","Matrix","onPropChange","setProps","setProp","hasChanged","includes","paintCache","identity","clipPath","undefined","clipRect","clipRRect","computeMatrix","computeClip","addChild","child","JsiDeclarationNode","setInvalidate","insertChildBefore","before","clip","isPathDef","processPath","isRRect","processTransformProps","render","invertClip","layer","transform","canvas","parentPaint","paint","cache","parent","shouldRestore","saveAndConcat","hasTransform","hasClip","shouldSave","op","ClipOp","Difference","Intersect","saveLayer","save","concat","renderNode","restore","exports"],"sources":["RenderNode.ts"],"sourcesContent":["import type {\n  SkMatrix,\n  SkRect,\n  SkRRect,\n  SkPath,\n  SkPaint,\n} from \"../../skia/types\";\nimport { ClipOp, isRRect } from \"../../skia/types\";\nimport type {\n  RenderNode,\n  GroupProps,\n  NodeType,\n  Node,\n  DrawingContext,\n} from \"../types\";\n\nimport { isPathDef, processPath, processTransformProps } from \"./datatypes\";\nimport type { NodeContext } from \"./Node\";\nimport { JsiNode, JsiDeclarationNode } from \"./Node\";\n\nconst paintProps = [\n  \"color\",\n  \"strokeWidth\",\n  \"blendMode\",\n  \"strokeCap\",\n  \"strokeJoin\",\n  \"strokeMiter\",\n  \"style\",\n  \"antiAlias\",\n  \"dither\",\n  \"opacity\",\n];\n\ninterface PaintCache {\n  parent: SkPaint;\n  child: SkPaint;\n}\n\nexport abstract class JsiRenderNode<P extends GroupProps>\n  extends JsiNode<P>\n  implements RenderNode<P>\n{\n  paintCache: PaintCache | null = null;\n\n  matrix: SkMatrix;\n  clipRect?: SkRect;\n  clipRRect?: SkRRect;\n  clipPath?: SkPath;\n\n  constructor(ctx: NodeContext, type: NodeType, props: P) {\n    super(ctx, type, props);\n    this.matrix = this.Skia.Matrix();\n    this.onPropChange();\n  }\n\n  setProps(props: P) {\n    super.setProps(props);\n    this.onPropChange();\n  }\n\n  setProp<K extends keyof P>(key: K, value: P[K]) {\n    const hasChanged = super.setProp(key, value);\n    if (hasChanged) {\n      this.onPropChange();\n      if (paintProps.includes(key as string)) {\n        this.paintCache = null;\n      }\n    }\n    return hasChanged;\n  }\n\n  protected onPropChange() {\n    this.matrix.identity();\n    this.clipPath = undefined;\n    this.clipRect = undefined;\n    this.clipRRect = undefined;\n    this.computeMatrix();\n    this.computeClip();\n  }\n\n  addChild(child: Node<unknown>) {\n    if (child instanceof JsiDeclarationNode) {\n      child.setInvalidate(() => {\n        this.paintCache = null;\n      });\n    }\n    super.addChild(child);\n  }\n\n  insertChildBefore(child: Node<unknown>, before: Node<unknown>) {\n    if (child instanceof JsiDeclarationNode) {\n      child.setInvalidate(() => {\n        this.paintCache = null;\n      });\n    }\n    super.insertChildBefore(child, before);\n  }\n\n  private computeClip() {\n    const { clip } = this.props;\n    if (clip) {\n      if (isPathDef(clip)) {\n        this.clipPath = processPath(this.Skia, clip);\n      } else if (isRRect(clip)) {\n        this.clipRRect = clip;\n      } else {\n        this.clipRect = clip;\n      }\n    }\n  }\n\n  private computeMatrix() {\n    processTransformProps(this.matrix, this.props);\n  }\n\n  render(ctx: DrawingContext) {\n    const { invertClip, layer, matrix, transform } = this.props;\n    const { canvas } = ctx;\n    const parentPaint = ctx.paint;\n\n    const cache =\n      this.paintCache !== null && this.paintCache.parent === ctx.paint\n        ? this.paintCache.child\n        : undefined;\n    const shouldRestore = ctx.saveAndConcat(this, cache);\n\n    const hasTransform = matrix !== undefined || transform !== undefined;\n    const hasClip =\n      this.clipRect !== undefined ||\n      this.clipPath !== undefined ||\n      this.clipRRect !== undefined;\n    const shouldSave = hasTransform || hasClip || !!layer;\n    const op = invertClip ? ClipOp.Difference : ClipOp.Intersect;\n    if (shouldSave) {\n      if (layer) {\n        if (typeof layer === \"boolean\") {\n          canvas.saveLayer();\n        } else {\n          canvas.saveLayer(layer);\n        }\n      } else {\n        canvas.save();\n      }\n    }\n\n    if (this.matrix) {\n      canvas.concat(this.matrix);\n    }\n    if (this.clipRect) {\n      canvas.clipRect(this.clipRect, op, true);\n    } else if (this.clipRRect) {\n      canvas.clipRRect(this.clipRRect, op, true);\n    } else if (this.clipPath) {\n      canvas.clipPath(this.clipPath, op, true);\n    }\n\n    this.renderNode(ctx);\n\n    if (shouldSave) {\n      canvas.restore();\n    }\n    if (shouldRestore) {\n      this.paintCache = {\n        parent: parentPaint,\n        child: ctx.paint,\n      };\n      ctx.restore();\n    }\n  }\n\n  abstract renderNode(ctx: DrawingContext): void;\n}\n"],"mappings":"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"}