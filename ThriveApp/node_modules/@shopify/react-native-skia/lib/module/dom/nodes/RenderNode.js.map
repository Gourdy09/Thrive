{"version":3,"names":["ClipOp","isRRect","isPathDef","processPath","processTransformProps","JsiNode","JsiDeclarationNode","paintProps","JsiRenderNode","constructor","ctx","type","props","_defineProperty","matrix","Skia","Matrix","onPropChange","setProps","setProp","key","value","hasChanged","includes","paintCache","identity","clipPath","undefined","clipRect","clipRRect","computeMatrix","computeClip","addChild","child","setInvalidate","insertChildBefore","before","clip","render","invertClip","layer","transform","canvas","parentPaint","paint","cache","parent","shouldRestore","saveAndConcat","hasTransform","hasClip","shouldSave","op","Difference","Intersect","saveLayer","save","concat","renderNode","restore"],"sources":["RenderNode.ts"],"sourcesContent":["import type {\n  SkMatrix,\n  SkRect,\n  SkRRect,\n  SkPath,\n  SkPaint,\n} from \"../../skia/types\";\nimport { ClipOp, isRRect } from \"../../skia/types\";\nimport type {\n  RenderNode,\n  GroupProps,\n  NodeType,\n  Node,\n  DrawingContext,\n} from \"../types\";\n\nimport { isPathDef, processPath, processTransformProps } from \"./datatypes\";\nimport type { NodeContext } from \"./Node\";\nimport { JsiNode, JsiDeclarationNode } from \"./Node\";\n\nconst paintProps = [\n  \"color\",\n  \"strokeWidth\",\n  \"blendMode\",\n  \"strokeCap\",\n  \"strokeJoin\",\n  \"strokeMiter\",\n  \"style\",\n  \"antiAlias\",\n  \"dither\",\n  \"opacity\",\n];\n\ninterface PaintCache {\n  parent: SkPaint;\n  child: SkPaint;\n}\n\nexport abstract class JsiRenderNode<P extends GroupProps>\n  extends JsiNode<P>\n  implements RenderNode<P>\n{\n  paintCache: PaintCache | null = null;\n\n  matrix: SkMatrix;\n  clipRect?: SkRect;\n  clipRRect?: SkRRect;\n  clipPath?: SkPath;\n\n  constructor(ctx: NodeContext, type: NodeType, props: P) {\n    super(ctx, type, props);\n    this.matrix = this.Skia.Matrix();\n    this.onPropChange();\n  }\n\n  setProps(props: P) {\n    super.setProps(props);\n    this.onPropChange();\n  }\n\n  setProp<K extends keyof P>(key: K, value: P[K]) {\n    const hasChanged = super.setProp(key, value);\n    if (hasChanged) {\n      this.onPropChange();\n      if (paintProps.includes(key as string)) {\n        this.paintCache = null;\n      }\n    }\n    return hasChanged;\n  }\n\n  protected onPropChange() {\n    this.matrix.identity();\n    this.clipPath = undefined;\n    this.clipRect = undefined;\n    this.clipRRect = undefined;\n    this.computeMatrix();\n    this.computeClip();\n  }\n\n  addChild(child: Node<unknown>) {\n    if (child instanceof JsiDeclarationNode) {\n      child.setInvalidate(() => {\n        this.paintCache = null;\n      });\n    }\n    super.addChild(child);\n  }\n\n  insertChildBefore(child: Node<unknown>, before: Node<unknown>) {\n    if (child instanceof JsiDeclarationNode) {\n      child.setInvalidate(() => {\n        this.paintCache = null;\n      });\n    }\n    super.insertChildBefore(child, before);\n  }\n\n  private computeClip() {\n    const { clip } = this.props;\n    if (clip) {\n      if (isPathDef(clip)) {\n        this.clipPath = processPath(this.Skia, clip);\n      } else if (isRRect(clip)) {\n        this.clipRRect = clip;\n      } else {\n        this.clipRect = clip;\n      }\n    }\n  }\n\n  private computeMatrix() {\n    processTransformProps(this.matrix, this.props);\n  }\n\n  render(ctx: DrawingContext) {\n    const { invertClip, layer, matrix, transform } = this.props;\n    const { canvas } = ctx;\n    const parentPaint = ctx.paint;\n\n    const cache =\n      this.paintCache !== null && this.paintCache.parent === ctx.paint\n        ? this.paintCache.child\n        : undefined;\n    const shouldRestore = ctx.saveAndConcat(this, cache);\n\n    const hasTransform = matrix !== undefined || transform !== undefined;\n    const hasClip =\n      this.clipRect !== undefined ||\n      this.clipPath !== undefined ||\n      this.clipRRect !== undefined;\n    const shouldSave = hasTransform || hasClip || !!layer;\n    const op = invertClip ? ClipOp.Difference : ClipOp.Intersect;\n    if (shouldSave) {\n      if (layer) {\n        if (typeof layer === \"boolean\") {\n          canvas.saveLayer();\n        } else {\n          canvas.saveLayer(layer);\n        }\n      } else {\n        canvas.save();\n      }\n    }\n\n    if (this.matrix) {\n      canvas.concat(this.matrix);\n    }\n    if (this.clipRect) {\n      canvas.clipRect(this.clipRect, op, true);\n    } else if (this.clipRRect) {\n      canvas.clipRRect(this.clipRRect, op, true);\n    } else if (this.clipPath) {\n      canvas.clipPath(this.clipPath, op, true);\n    }\n\n    this.renderNode(ctx);\n\n    if (shouldSave) {\n      canvas.restore();\n    }\n    if (shouldRestore) {\n      this.paintCache = {\n        parent: parentPaint,\n        child: ctx.paint,\n      };\n      ctx.restore();\n    }\n  }\n\n  abstract renderNode(ctx: DrawingContext): void;\n}\n"],"mappings":";;;AAOA,SAASA,MAAM,EAAEC,OAAO,QAAQ,kBAAkB;AASlD,SAASC,SAAS,EAAEC,WAAW,EAAEC,qBAAqB,QAAQ,aAAa;AAE3E,SAASC,OAAO,EAAEC,kBAAkB,QAAQ,QAAQ;AAEpD,MAAMC,UAAU,GAAG,CACjB,OAAO,EACP,aAAa,EACb,WAAW,EACX,WAAW,EACX,YAAY,EACZ,aAAa,EACb,OAAO,EACP,WAAW,EACX,QAAQ,EACR,SAAS,CACV;AAOD,OAAO,MAAeC,aAAa,SACzBH,OAAO,CAEjB;EAQEI,WAAWA,CAACC,GAAgB,EAAEC,IAAc,EAAEC,KAAQ,EAAE;IACtD,KAAK,CAACF,GAAG,EAAEC,IAAI,EAAEC,KAAK,CAAC;IAACC,eAAA,qBARM,IAAI;IAAAA,eAAA;IAAAA,eAAA;IAAAA,eAAA;IAAAA,eAAA;IASlC,IAAI,CAACC,MAAM,GAAG,IAAI,CAACC,IAAI,CAACC,MAAM,CAAC,CAAC;IAChC,IAAI,CAACC,YAAY,CAAC,CAAC;EACrB;EAEAC,QAAQA,CAACN,KAAQ,EAAE;IACjB,KAAK,CAACM,QAAQ,CAACN,KAAK,CAAC;IACrB,IAAI,CAACK,YAAY,CAAC,CAAC;EACrB;EAEAE,OAAOA,CAAoBC,GAAM,EAAEC,KAAW,EAAE;IAC9C,MAAMC,UAAU,GAAG,KAAK,CAACH,OAAO,CAACC,GAAG,EAAEC,KAAK,CAAC;IAC5C,IAAIC,UAAU,EAAE;MACd,IAAI,CAACL,YAAY,CAAC,CAAC;MACnB,IAAIV,UAAU,CAACgB,QAAQ,CAACH,GAAa,CAAC,EAAE;QACtC,IAAI,CAACI,UAAU,GAAG,IAAI;MACxB;IACF;IACA,OAAOF,UAAU;EACnB;EAEUL,YAAYA,CAAA,EAAG;IACvB,IAAI,CAACH,MAAM,CAACW,QAAQ,CAAC,CAAC;IACtB,IAAI,CAACC,QAAQ,GAAGC,SAAS;IACzB,IAAI,CAACC,QAAQ,GAAGD,SAAS;IACzB,IAAI,CAACE,SAAS,GAAGF,SAAS;IAC1B,IAAI,CAACG,aAAa,CAAC,CAAC;IACpB,IAAI,CAACC,WAAW,CAAC,CAAC;EACpB;EAEAC,QAAQA,CAACC,KAAoB,EAAE;IAC7B,IAAIA,KAAK,YAAY3B,kBAAkB,EAAE;MACvC2B,KAAK,CAACC,aAAa,CAAC,MAAM;QACxB,IAAI,CAACV,UAAU,GAAG,IAAI;MACxB,CAAC,CAAC;IACJ;IACA,KAAK,CAACQ,QAAQ,CAACC,KAAK,CAAC;EACvB;EAEAE,iBAAiBA,CAACF,KAAoB,EAAEG,MAAqB,EAAE;IAC7D,IAAIH,KAAK,YAAY3B,kBAAkB,EAAE;MACvC2B,KAAK,CAACC,aAAa,CAAC,MAAM;QACxB,IAAI,CAACV,UAAU,GAAG,IAAI;MACxB,CAAC,CAAC;IACJ;IACA,KAAK,CAACW,iBAAiB,CAACF,KAAK,EAAEG,MAAM,CAAC;EACxC;EAEQL,WAAWA,CAAA,EAAG;IACpB,MAAM;MAAEM;IAAK,CAAC,GAAG,IAAI,CAACzB,KAAK;IAC3B,IAAIyB,IAAI,EAAE;MACR,IAAInC,SAAS,CAACmC,IAAI,CAAC,EAAE;QACnB,IAAI,CAACX,QAAQ,GAAGvB,WAAW,CAAC,IAAI,CAACY,IAAI,EAAEsB,IAAI,CAAC;MAC9C,CAAC,MAAM,IAAIpC,OAAO,CAACoC,IAAI,CAAC,EAAE;QACxB,IAAI,CAACR,SAAS,GAAGQ,IAAI;MACvB,CAAC,MAAM;QACL,IAAI,CAACT,QAAQ,GAAGS,IAAI;MACtB;IACF;EACF;EAEQP,aAAaA,CAAA,EAAG;IACtB1B,qBAAqB,CAAC,IAAI,CAACU,MAAM,EAAE,IAAI,CAACF,KAAK,CAAC;EAChD;EAEA0B,MAAMA,CAAC5B,GAAmB,EAAE;IAC1B,MAAM;MAAE6B,UAAU;MAAEC,KAAK;MAAE1B,MAAM;MAAE2B;IAAU,CAAC,GAAG,IAAI,CAAC7B,KAAK;IAC3D,MAAM;MAAE8B;IAAO,CAAC,GAAGhC,GAAG;IACtB,MAAMiC,WAAW,GAAGjC,GAAG,CAACkC,KAAK;IAE7B,MAAMC,KAAK,GACT,IAAI,CAACrB,UAAU,KAAK,IAAI,IAAI,IAAI,CAACA,UAAU,CAACsB,MAAM,KAAKpC,GAAG,CAACkC,KAAK,GAC5D,IAAI,CAACpB,UAAU,CAACS,KAAK,GACrBN,SAAS;IACf,MAAMoB,aAAa,GAAGrC,GAAG,CAACsC,aAAa,CAAC,IAAI,EAAEH,KAAK,CAAC;IAEpD,MAAMI,YAAY,GAAGnC,MAAM,KAAKa,SAAS,IAAIc,SAAS,KAAKd,SAAS;IACpE,MAAMuB,OAAO,GACX,IAAI,CAACtB,QAAQ,KAAKD,SAAS,IAC3B,IAAI,CAACD,QAAQ,KAAKC,SAAS,IAC3B,IAAI,CAACE,SAAS,KAAKF,SAAS;IAC9B,MAAMwB,UAAU,GAAGF,YAAY,IAAIC,OAAO,IAAI,CAAC,CAACV,KAAK;IACrD,MAAMY,EAAE,GAAGb,UAAU,GAAGvC,MAAM,CAACqD,UAAU,GAAGrD,MAAM,CAACsD,SAAS;IAC5D,IAAIH,UAAU,EAAE;MACd,IAAIX,KAAK,EAAE;QACT,IAAI,OAAOA,KAAK,KAAK,SAAS,EAAE;UAC9BE,MAAM,CAACa,SAAS,CAAC,CAAC;QACpB,CAAC,MAAM;UACLb,MAAM,CAACa,SAAS,CAACf,KAAK,CAAC;QACzB;MACF,CAAC,MAAM;QACLE,MAAM,CAACc,IAAI,CAAC,CAAC;MACf;IACF;IAEA,IAAI,IAAI,CAAC1C,MAAM,EAAE;MACf4B,MAAM,CAACe,MAAM,CAAC,IAAI,CAAC3C,MAAM,CAAC;IAC5B;IACA,IAAI,IAAI,CAACc,QAAQ,EAAE;MACjBc,MAAM,CAACd,QAAQ,CAAC,IAAI,CAACA,QAAQ,EAAEwB,EAAE,EAAE,IAAI,CAAC;IAC1C,CAAC,MAAM,IAAI,IAAI,CAACvB,SAAS,EAAE;MACzBa,MAAM,CAACb,SAAS,CAAC,IAAI,CAACA,SAAS,EAAEuB,EAAE,EAAE,IAAI,CAAC;IAC5C,CAAC,MAAM,IAAI,IAAI,CAAC1B,QAAQ,EAAE;MACxBgB,MAAM,CAAChB,QAAQ,CAAC,IAAI,CAACA,QAAQ,EAAE0B,EAAE,EAAE,IAAI,CAAC;IAC1C;IAEA,IAAI,CAACM,UAAU,CAAChD,GAAG,CAAC;IAEpB,IAAIyC,UAAU,EAAE;MACdT,MAAM,CAACiB,OAAO,CAAC,CAAC;IAClB;IACA,IAAIZ,aAAa,EAAE;MACjB,IAAI,CAACvB,UAAU,GAAG;QAChBsB,MAAM,EAAEH,WAAW;QACnBV,KAAK,EAAEvB,GAAG,CAACkC;MACb,CAAC;MACDlC,GAAG,CAACiD,OAAO,CAAC,CAAC;IACf;EACF;AAGF"}