"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.evaluateConfigWithEnvVarsAsync = void 0;
const tslib_1 = require("tslib");
const generated_1 = require("../graphql/generated");
const EnvironmentVariablesQuery_1 = require("../graphql/queries/EnvironmentVariablesQuery");
const log_1 = tslib_1.__importStar(require("../log"));
function isEnvironment(env) {
    return Object.values(generated_1.EnvironmentVariableEnvironment).includes(env);
}
async function evaluateConfigWithEnvVarsAsync({ buildProfile, buildProfileName, graphqlClient, getProjectConfig, opts, }) {
    if (!graphqlClient) {
        log_1.default.warn('An Expo user account is required to fetch environment variables.');
        const config = await getProjectConfig(opts);
        return { env: buildProfile.env ?? {}, ...config };
    }
    const { projectId } = await getProjectConfig({ env: buildProfile.env, ...opts });
    const env = await resolveEnvVarsAsync({
        buildProfile,
        buildProfileName,
        graphqlClient,
        projectId,
    });
    const config = await getProjectConfig({ ...opts, env });
    return { env, ...config };
}
exports.evaluateConfigWithEnvVarsAsync = evaluateConfigWithEnvVarsAsync;
async function resolveEnvVarsAsync({ buildProfile, buildProfileName, graphqlClient, projectId, }) {
    const environment = buildProfile.environment?.toUpperCase() ?? process.env.EAS_CURRENT_ENVIRONMENT;
    if (!environment || !isEnvironment(environment)) {
        log_1.default.log(`Loaded "env" configuration for the "${buildProfileName}" profile: ${buildProfile.env && Object.keys(buildProfile.env).length > 0
            ? Object.keys(buildProfile.env).join(', ')
            : 'no environment variables specified'}. ${(0, log_1.learnMore)('https://docs.expo.dev/build-reference/variables/')}`);
        return { ...buildProfile.env };
    }
    try {
        const environmentVariables = await EnvironmentVariablesQuery_1.EnvironmentVariablesQuery.byAppIdWithSensitiveAsync(graphqlClient, {
            appId: projectId,
            environment,
        });
        const serverEnvVars = Object.fromEntries(environmentVariables
            .filter(({ name, value }) => name && value)
            .map(({ name, value }) => [name, value]));
        const envVarsWithSource = {
            ...Object.fromEntries(Object.keys(serverEnvVars).map(key => [key, 'EAS server'])),
            ...(buildProfile.env
                ? Object.fromEntries(Object.keys(buildProfile.env).map(key => [key, 'build profile']))
                : null),
        };
        log_1.default.log(`Loaded "env" configuration for the "${buildProfileName}" profile and "${environment.toLowerCase()}" environment: ${Object.keys(envVarsWithSource).length > 0
            ? Object.keys(envVarsWithSource)
                .map(key => `${key} (source: ${envVarsWithSource[key]})`)
                .join('\n')
            : 'no environment variables specified'}\n${(0, log_1.learnMore)('https://docs.expo.dev/build-reference/variables/')}`);
        return { ...serverEnvVars, ...buildProfile.env };
    }
    catch (e) {
        log_1.default.error(`Failed to pull env variables for environment ${environment} from EAS servers`);
        log_1.default.error(e);
        log_1.default.error('This can possibly be a bug in EAS/EAS CLI. Report it here: https://github.com/expo/eas-cli/issues');
        return { ...buildProfile.env };
    }
}
